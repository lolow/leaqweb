library('ggplot2')
library('gdata')
d <- read.table("<%= @output.file('csv') %>",sep=",",dec=".",h=TRUE)
d <- subset(d,attribute=="<%= @query[:attribute] %>")
<% if @query[:filter].size > 0 %>
d <- subset(d,<%= @query[:filter] %>)
<% end %>
d <- cast(d, <%=@query[:rows]%> + <%=@query[:columns]%> ~ ., fun.aggregate=<%=@query[:aggregate]%> )
colnames(d) <- c("<%=@query[:rows]%>","<%=@query[:columns]%>","<%=@query[:aggregate]%>")
p = ggplot(data=drop.levels(d),aes(x=<%=@query[:columns]%>,y=<%=@query[:aggregate]%>,group=<%=@query[:rows]%>,colour=<%=@query[:rows]%>))
p = p + geom_line()
p = p + opts(title='<%= @query[:name] %>')
p = p + geom_point()
p = p + labs(x="",y="",colour="")
ggsave(filename = "<%= @output.file('png') %>",plot=p,device=png,width=1618/2,height=1000/2,dpi=72,scale=1)
